# 以太坊链游设计思路

## 一、游戏概述

本游戏核心玩法是一个基于以太坊支付的老虎机模拟器，玩家在链接了以太坊钱包后，可以通过支付一定的入场费（如0.05eth）换取一定数额的代币（10000量子），游戏共基础进行五轮，五轮成功后的每轮结束后玩家可以选择加注。五轮前每轮成功可以获得五分之一入场费的累计奖励，而五轮后选择加注的每轮可以获得全额入场费的奖励。某一轮失败则游戏结束，失去入场费并失去所有累计报酬。

### 每轮获胜条件：

每轮游戏开始时会有一个回合倒计时，回合数为7回合，每回合开始时，玩家可以选择花费3000乘以轮数或7000乘以轮数的量子获得3次老虎机机会以及2颗圣晶石或7次老虎机机会以及1颗圣晶石。然后玩家旋转老虎机，通过老虎机的倍率赚取量子。每回合结束，玩家可以选择存入一部分量子，然后在完整一轮结束后，结算玩家总量子数，若大于一个数，即可通过，否则失败。若通过，总量子余额作为下一轮玩家的本金，即每轮结束量子不会清空。

### 辅助从者（辅助增益buff）：

每回合玩家可以进入从者商店购买辅助从者，每回合商店会固定刷新三个从者，每个从者价格初始都是3颗圣晶石的整数倍，每个从者都有各自的增益buff，玩家购买后，从者进入仓库，玩家最多可以登场五个从者来提供buff，仓库中的从者不生效buff。

### 老虎机机制：

游戏主体的老虎机采用3×5的结构，3行5列，共十五个方块区域，显示十五个图像，依据相同图像构成的形状（位置关系）获得不同的倍率加成，每个形状之间的分数加算，每个形状有基础分数（可通过部分buff加成），每个图像也有各自的基础分数（也可通过部分buff加成）每个图像有自己出现的基础概率（可以通过buff提升或降低），一共有10个图像，其中9个是加分图像，一个是扣分图像。形状的结算之前可以互相重叠，即只要出现了形状就结算，不考虑这个位置的图像是否已经使用过。注意，当抽取到扣分图像时会扣掉本回合到现在位置的所有点数。

### 事件机制：

每轮游戏开始时，玩家可以从三个事件中选取一个，有三个模板：1.增加某个图像的出现概率权重，2.增加某个图像的基础倍率，3.获得某个图像的全满形状加分一次。其中某个图像从十个图像中选则填入，可以不一样，也可以一样。

## 二、具体机制介绍

### 每轮结算量子数量：

第一轮：100000量子

第二轮：500000量子

第三轮：1500000量子

第四轮：4000000量子

第五轮：7500000量子

之后的轮数递增。

### 名词介绍：

#### 图像：

各个图像的基础倍率均为1000量子

各自拥有初始出现权重1，每次有概率更新时根据权重重新计算概率

九个加分图像

阿尔托莉雅：

![愚人节_卡面_FFJ_002](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_002.png)

吉尔伽美什：

![愚人节_卡面_FFJ_012](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_012.png)

织田信长：

![愚人节_卡面_FFJ_069](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_069.png)

贞德alter：

![愚人节_卡面_FFJ_106](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_106.png)

伊什塔尔：

![愚人节_卡面_FFJ_142](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_142.png)

尼禄：

![愚人节_卡面_FFJ_175](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_175.png)

千子村正：

![愚人节_卡面_FFJ_302](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_302.png)

phantasmoon：

![愚人节_卡面_FFJ_431](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_431.png)

梅尔特莉莉丝：

![愚人节_卡面_FFJ_163](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_163.png)



以及一个扣分图像：

所罗门：

![愚人节_卡面_FFJ_083](D:\fgochaingame\素材\img\愚人节_卡面_FFJ_083.png)

扣分图像默认每轮结束时扣分提升100%

#### 加成从者：

1.bb

![BB迪拜_status_1](D:\fgochaingame\素材\img\BB迪拜_status_1.png)

价格：6圣晶石

效果：所有来源获得的量子翻倍（总是最后结算，即在算出能获得的量子总数后翻倍）

2.恩奇都

![Servant143正面2](D:\fgochaingame\素材\img\Servant143正面2.png)

价格：3圣晶石

效果：吉尔伽美什类型的图像基础倍率提升100%，出现概率权重提升100%

3.葛饰北斋

![Servant198正面2](D:\fgochaingame\素材\img\Servant198正面2.png)

价格：6圣晶石

效果：每回合额外获得一次老虎机机会

4.斯卡蒂

![Servant215正面1](D:\fgochaingame\素材\img\Servant215正面1.png)

价格：9圣晶石

效果：每回合开始时自动结算一次上v和下v形状的，当前倍率最高的图像的点数

5.巴万希

![バーヴァン・シー_status_1](D:\fgochaingame\素材\img\バーヴァン・シー_status_1.png)

价格：3圣晶石

效果：扣分图像的基础倍率减半，扣分图像的权重减半

6.摩根

![モルガン_status_1](D:\fgochaingame\素材\img\モルガン_status_1.png)

价格：3圣晶石

效果：阿尔托莉雅类型的图像基础倍率提升100%，出现概率权重提升100%

7.卡斯特



![阿尔托莉雅·卡斯特_status_2](D:\fgochaingame\素材\img\阿尔托莉雅·卡斯特_status_2.png)

价格：9圣晶石

效果：获得的圣晶石提升100%

8.卡莲

![阿摩耳〔卡莲〕_status_2](D:\fgochaingame\素材\img\阿摩耳〔卡莲〕_status_2.png)

价格：6圣晶石

效果：每回合开始时自动结算两次横三和竖三形状的，当前倍率最高的图像的点数

9.艾蕾

![埃列什基伽勒(Beast)_status_1](D:\fgochaingame\素材\img\埃列什基伽勒(Beast)_status_1.png)

价格：6圣晶石

效果：通过上v和下v获得的量子数量提升100%

10.奥博龙



![奥伯龙_status_1](D:\fgochaingame\素材\img\奥伯龙_status_1.png)

价格：6圣晶石

效果：回合开始时，手中所持量子-50%，回合结束时，手中所持量子+200%

11.青子

![超级青子_status](D:\fgochaingame\素材\img\超级青子_status.png)

价格：6圣晶石

效果：每轮多一回合

12.卫宫

![Servant011正面1](D:\fgochaingame\素材\img\Servant011正面1.png)

价格：3圣晶石

效果：千子村正类型的图像基础倍率提升100%，出现概率权重提升100%

13.花嫁尼禄

![花嫁头像2](D:\fgochaingame\素材\img\花嫁头像2.png)

价格：3圣晶石

效果：尼禄类型的图像基础倍率提升100%，出现概率权重提升100%

14.羽蛇神

![魁札尔·科亚特尔头像3](D:\fgochaingame\素材\img\魁札尔·科亚特尔头像3.png)

价格：6圣晶石

效果：每回合开始时自动结算三次横五形状的，当前倍率最高的图像的点数

15.莉莉丝

![莉莉丝_status_1](D:\fgochaingame\素材\img\莉莉丝_status_1.png)

价格：9圣晶石

效果：每轮多获得一次选择事件的机会

16.卢屋道满

![芦屋道满_status_1](D:\fgochaingame\素材\img\芦屋道满_status_1.png)

价格：3圣晶石

效果：扣分类型的图像基础倍率提升100%，出现概率权重提升100%

17.罗穆卢斯

![罗穆路斯·奎里努斯_status_2](D:\fgochaingame\素材\img\罗穆路斯·奎里努斯_status_2.png)

价格：9圣晶石

效果：每回合开始时自动结算一次全满形状的，当前倍率最高的图像的点数

18.梅柳齐娜

![梅柳齐娜(Ruler)_status_1](D:\fgochaingame\素材\img\梅柳齐娜(Ruler)_status_1.png)

价格：9圣晶石

效果：所有从者价格下降一档：9个变6个，6个变3个，3个变免费

19.西耶尔

![谜之代行者C.I.E.L_status_2](D:\fgochaingame\素材\img\谜之代行者C.I.E.L_status_2.png)

价格：3圣晶石

效果：phantasmoon类型的图像基础倍率提升100%，出现概率权重提升100%

20.魔王信长

![魔王信长_status_1](D:\fgochaingame\素材\img\魔王信长_status_1.png)

价格：3圣晶石

效果：织田信长类型的图像基础倍率提升100%，出现概率权重提升100%

21.始皇帝

![秦始皇_正面1](D:\fgochaingame\素材\img\秦始皇_正面1.png)

价格：9圣晶石

效果：每轮需要达到的目标下降25%

22.青少纳言

![清少纳言_status_1](D:\fgochaingame\素材\img\清少纳言_status_1.png)

价格：3圣晶石

效果：更新一次从者商店，然后失效（一次性）

23.莱尼斯

![司马懿_status_1](D:\fgochaingame\素材\img\司马懿_status_1.png)

价格：3圣晶石

效果：购买从者的价格永久-1

24.太公望

![太公望_status_1](D:\fgochaingame\素材\img\太公望_status_1.png)

价格：3圣晶石

效果：变成随机一个从者，然后失效（一次性）

25.太空伊什塔尔



![太空伊什塔尔_status_2](D:\fgochaingame\素材\img\太空伊什塔尔_status_2.png)

价格：3圣晶石

效果：伊什塔尔类型的图像基础倍率提升100%，出现概率权重提升100%

26.烟雾镜



![特斯卡特利波卡_status_1](D:\fgochaingame\素材\img\特斯卡特利波卡_status_1.png)

价格：6圣晶石

效果：变成随机一个9圣晶石的从者，然后失效（一次性）

27.王哈桑

![王哈头像3](D:\fgochaingame\素材\img\王哈头像3.png)

价格：3圣晶石

效果：免疫扣分图像的扣除量子效果

28.武藏

![武藏头像3](D:\fgochaingame\素材\img\武藏头像3.png)

价格：0圣晶石

效果：变成随机一个3圣晶石的从者，然后失效（一次性）

29.刑部姬

![刑部姬头像2](D:\fgochaingame\素材\img\刑部姬头像2.png)

价格：3圣晶石

效果：梅尔特莉莉丝类型的图像基础倍率提升100%，出现概率权重提升100%

30亚瑟

![亚瑟·潘德拉贡-头像-2](D:\fgochaingame\素材\img\亚瑟·潘德拉贡-头像-2.png)

价格：6圣晶石

效果：扣分图像不在扣分，且不在触发连携时将累计分数扣完

31.伯爵

![岩窟王_基督山_status_3](D:\fgochaingame\素材\img\岩窟王_基督山_status_3.png)

价格：3圣晶石

效果：贞德alter类型的图像基础倍率提升100%，出现概率权重提升100%

32.杨贵妃

![杨贵妃_status_2](D:\fgochaingame\素材\img\杨贵妃_status_2.png)

价格：3圣晶石

效果：变成随机一个6圣晶石的从者，然后失效（一次性）

33.龙娘

![伊丽莎白·巴托里(SSR)_status_1](D:\fgochaingame\素材\img\伊丽莎白·巴托里(SSR)_status_1.png)

价格：9圣晶石

效果：变成随机两个从者，然后失效（一次性）

#### 形状：

1.横三：横向三个连续相同图像，每格算三倍，一共算9倍

2竖三：纵向三个连续相同图像，倍率同横三

3.横五：横向五个连续相同图像，每格算五倍，一共算25倍

4上v：第一排第一五个，第二排第二四个，第三排第三个是相同图像，倍率为35倍

5.下v：上下颠倒的上v

6.全满：全部格子为连续相同图像，倍率为225倍

#### 货币：

圣晶石：

![圣晶石](D:\fgochaingame\素材\img\圣晶石.png)

量子：

![QP](D:\fgochaingame\素材\img\QP.png)

### 三、实现思路

前端界面正中心为一个3×5老虎机不需要做动画，能够更新结果就行，有一个按钮触发老虎机，有计数器显示轮数，剩余回合数，持有量子数，圣晶石数量，有一个物品栏显示持有从者，可以点击打开背包，更换上场从者，触发事件时有选择框选择事件。

后端需要注意，前文中所有的百分比计算都为加算，如果值低于0则不生效，区块链部分在实现了整体功能后在添加

---

## 四、系统架构设计

### 4.1 前后端设计原理

#### 前端设计原理

前端采用 **React 18** 框架构建，采用组件化设计，主要包含以下核心模块：

**1. 路由管理（App.js）**
- 使用 React Router 管理页面路由
- 支持两种游戏模式：游客模式（Guest Mode）和以太坊模式（Ethereum Mode）
- 统一管理游戏状态（sessionId、gameState、probabilities等）
- 处理游戏初始化、重启等生命周期

**2. 钱包连接模块（WalletConnect.js）**
- 集成 MetaMask 钱包连接
- 自动切换到 Sepolia 测试网络
- 处理入场费支付（调用智能合约 `startGame` 方法）
- 实时显示钱包余额和连接状态
- 监听账户和网络变化

**3. 游戏主界面（MainGame.js）**
- 显示游戏核心信息：轮数、回合数、量子、圣晶石
- 集成从者管理、事件选择、老虎机等子组件
- 处理游戏流程：开始轮次、完成轮次、完成游戏
- 支持主动完成游戏并提取奖励功能

**4. 老虎机组件（SlotMachinePage.js）**
- 3×5 网格布局显示
- 形状检测和奖励计算
- 支持多次旋转和机会计数

**5. 从者管理（ServantManager.js）**
- 从者商店展示和购买
- 仓库和出战栏管理
- 支持从者下场功能

**6. 游戏结束页面（GameOverPage.js）**
- 显示游戏统计信息
- 以太坊模式下显示奖励信息
- 支持提取奖励功能

**前端数据流：**
```
用户操作 → React组件 → API调用 → 后端服务器 → 返回数据 → 更新状态 → 重新渲染
```

#### 后端设计原理

后端采用 **Node.js + Express** 构建 RESTful API，主要职责包括：

**1. 游戏状态管理（GameState.js）**
- 管理游戏核心状态：量子、圣晶石、轮数、回合数
- 从者效果应用和移除
- 事件系统处理
- 老虎机概率计算和奖励结算

**2. 智能合约交互（contract.js）**
- 使用 Ethers.js 连接以太坊网络
- 封装合约方法调用：`completeLevel`、`completeGame`、`failGame`
- 处理交易签名和确认
- 错误处理和重试机制

**3. API路由设计（index.js）**
- `/api/game/new` - 创建新游戏会话
- `/api/game/:sessionId` - 获取游戏状态
- `/api/game/:sessionId/level/complete` - 完成轮次（自动调用合约）
- `/api/game/:sessionId/game/complete` - 完成游戏（自动支付奖励）
- `/api/game/:sessionId/servant/*` - 从者管理相关接口
- `/api/game/:sessionId/slot/spin` - 老虎机旋转
- `/api/game/:sessionId/report` - 获取游戏报表

**4. 游戏会话存储**
- 使用内存 Map 存储游戏状态（生产环境应使用数据库）
- 存储游戏元数据（模式、钱包地址、交易哈希等）
- 支持多用户并发游戏

**后端数据流：**
```
API请求 → Express路由 → 游戏逻辑处理 → 智能合约调用（以太坊模式） → 返回结果
```

#### 智能合约设计原理

智能合约采用 **Solidity 0.8.19** 编写，部署在以太坊 Sepolia 测试网：

**核心功能：**
1. **入场费管理**：玩家支付 0.05 ETH 入场费
2. **奖励累计**：记录每轮完成的奖励
3. **自动支付**：游戏完成时自动支付累计奖励
4. **失败处理**：游戏失败时清除奖励记录

**关键设计：**
- 使用 `bytes32` 类型的 `sessionId` 标识游戏会话
- 使用 `onlyOwner` 修饰符保护管理员函数
- 事件日志记录所有重要操作
- 支持玩家主动提取奖励（备用方法）

---

### 4.2 智能合约代码

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

/**
 * @title FGOGame
 * @dev FGO老虎机游戏的智能合约，管理入场费和奖励支付
 */
contract FGOGame {
    // 游戏管理员地址
    address public owner;
    
    // 入场费金额（wei）
    uint256 public constant ENTRY_FEE = 0.05 ether; // 0.05 ETH
    
    // 前五轮每轮奖励（wei）
    uint256 public constant LEVEL_REWARD = 0.01 ether; // 0.01 ETH (1/5 of entry fee)
    
    // 五轮后每轮奖励（wei）
    uint256 public constant POST_LEVEL_REWARD = 0.05 ether; // 0.05 ETH (full entry fee)
    
    // 游戏会话结构
    struct GameSession {
        address player;
        uint256 entryFeePaid;
        uint256 totalReward;
        uint256 completedLevels;
        bool isActive;
        bool isCompleted;
    }
    
    // 游戏会话映射
    mapping(bytes32 => GameSession) public gameSessions;
    
    // 玩家总奖励映射
    mapping(address => uint256) public playerTotalRewards;
    
    // 事件
    event GameStarted(bytes32 indexed sessionId, address indexed player, uint256 entryFee);
    event LevelCompleted(bytes32 indexed sessionId, address indexed player, uint256 level, uint256 reward);
    event GameCompleted(bytes32 indexed sessionId, address indexed player, uint256 totalReward);
    event RewardClaimed(address indexed player, uint256 amount);
    event GameFailed(bytes32 indexed sessionId, address indexed player);
    
    // 修饰符：只有管理员可以调用
    modifier onlyOwner() {
        require(msg.sender == owner, "Only owner can call this function");
        _;
    }
    
    constructor() {
        owner = msg.sender;
    }
    
    /**
     * @dev 开始新游戏（支付入场费）
     * @param sessionId 游戏会话ID
     */
    function startGame(bytes32 sessionId) external payable {
        require(msg.value == ENTRY_FEE, "Incorrect entry fee amount");
        require(!gameSessions[sessionId].isActive, "Game session already exists");
        
        gameSessions[sessionId] = GameSession({
            player: msg.sender,
            entryFeePaid: msg.value,
            totalReward: 0,
            completedLevels: 0,
            isActive: true,
            isCompleted: false
        });
        
        emit GameStarted(sessionId, msg.sender, msg.value);
    }
    
    /**
     * @dev 完成一轮游戏（由服务器调用）
     * @param sessionId 游戏会话ID
     * @param level 完成的轮数
     * @param isPostLevel5 是否超过5轮
     */
    function completeLevel(bytes32 sessionId, uint256 level, bool isPostLevel5) external onlyOwner {
        GameSession storage session = gameSessions[sessionId];
        require(session.isActive, "Game session not active");
        require(!session.isCompleted, "Game already completed");
        
        uint256 reward;
        if (isPostLevel5) {
            // 五轮后：全额入场费奖励
            reward = POST_LEVEL_REWARD;
        } else {
            // 前五轮：1/5入场费奖励
            reward = LEVEL_REWARD;
        }
        
        session.totalReward += reward;
        session.completedLevels = level;
        playerTotalRewards[session.player] += reward;
        
        emit LevelCompleted(sessionId, session.player, level, reward);
    }
    
    /**
     * @dev 完成游戏（成功）
     * @param sessionId 游戏会话ID
     */
    function completeGame(bytes32 sessionId) external onlyOwner {
        GameSession storage session = gameSessions[sessionId];
        require(session.isActive, "Game session not active");
        require(!session.isCompleted, "Game already completed");
        
        session.isCompleted = true;
        session.isActive = false;
        
        // 支付奖励给玩家
        if (session.totalReward > 0) {
            payable(session.player).transfer(session.totalReward);
        }
        
        emit GameCompleted(sessionId, session.player, session.totalReward);
    }
    
    /**
     * @dev 游戏失败（玩家失去入场费和奖励）
     * @param sessionId 游戏会话ID
     */
    function failGame(bytes32 sessionId) external onlyOwner {
        GameSession storage session = gameSessions[sessionId];
        require(session.isActive, "Game session not active");
        require(!session.isCompleted, "Game already completed");
        
        // 从玩家总奖励中扣除（如果有）
        if (playerTotalRewards[session.player] >= session.totalReward) {
            playerTotalRewards[session.player] -= session.totalReward;
        }
        
        session.isActive = false;
        session.isCompleted = false;
        
        emit GameFailed(sessionId, session.player);
    }
    
    /**
     * @dev 玩家提取奖励（备用方法）
     */
    function claimReward() external {
        uint256 reward = playerTotalRewards[msg.sender];
        require(reward > 0, "No reward to claim");
        
        playerTotalRewards[msg.sender] = 0;
        payable(msg.sender).transfer(reward);
        
        emit RewardClaimed(msg.sender, reward);
    }
    
    /**
     * @dev 获取游戏会话信息
     */
    function getGameSession(bytes32 sessionId) external view returns (
        address player,
        uint256 entryFeePaid,
        uint256 totalReward,
        uint256 completedLevels,
        bool isActive,
        bool isCompleted
    ) {
        GameSession memory session = gameSessions[sessionId];
        return (
            session.player,
            session.entryFeePaid,
            session.totalReward,
            session.completedLevels,
            session.isActive,
            session.isCompleted
        );
    }
    
    /**
     * @dev 获取玩家总奖励
     */
    function getPlayerReward(address player) external view returns (uint256) {
        return playerTotalRewards[player];
    }
    
    /**
     * @dev 提取合约余额（仅管理员）
     */
    function withdraw() external onlyOwner {
        payable(owner).transfer(address(this).balance);
    }
    
    /**
     * @dev 获取合约余额
     */
    function getContractBalance() external view returns (uint256) {
        return address(this).balance;
    }
    
    // 接收ETH
    receive() external payable {}
}
```

**合约关键特性：**
- **安全性**：使用 `onlyOwner` 修饰符保护管理员函数
- **奖励机制**：前5轮每轮 0.01 ETH，5轮后每轮 0.05 ETH
- **自动支付**：游戏完成时自动转账给玩家
- **事件日志**：记录所有重要操作，便于前端监听和追踪

---

### 4.3 前后端连接架构

#### 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户浏览器                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    React 前端应用                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │  │
│  │  │ WalletConnect│  │  MainGame    │  │ GameOverPage │ │  │
│  │  │ (钱包连接)   │  │  (主游戏)    │  │ (游戏结束)   │ │  │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │  │
│  │         │                  │                  │         │  │
│  │         │                  │                  │         │  │
│  │         └──────────────────┼──────────────────┘         │  │
│  │                            │                            │  │
│  │                    ┌───────▼────────┐                   │  │
│  │                    │  wallet.js     │                   │  │
│  │                    │ (Ethers.js)   │                   │  │
│  │                    └───────┬────────┘                   │  │
│  └────────────────────────────┼────────────────────────────┘  │
│                               │                               │
│                    ┌──────────┼──────────┐                   │
│                    │          │          │                    │
│         ┌──────────▼──┐  ┌───▼────┐  ┌──▼──────────┐        │
│         │  MetaMask   │  │ HTTP   │  │  Sepolia    │        │
│         │  钱包扩展   │  │  API   │  │  测试网络   │        │
│         └─────────────┘  └───┬───┘  └──────────────┘        │
└───────────────────────────────┼───────────────────────────────┘
                                │
                    ┌───────────▼───────────┐
                    │   Express 后端服务器   │
                    │   (localhost:3001)     │
                    │  ┌──────────────────┐ │
                    │  │   API Routes     │ │
                    │  │  - /game/new     │ │
                    │  │  - /level/       │ │
                    │  │  - /servant/     │ │
                    │  │  - /slot/spin    │ │
                    │  └────────┬─────────┘ │
                    │           │           │
                    │  ┌────────▼─────────┐ │
                    │  │  GameState.js    │ │
                    │  │  (游戏逻辑)     │ │
                    │  └────────┬─────────┘ │
                    │           │           │
                    │  ┌────────▼─────────┐ │
                    │  │  contract.js     │ │
                    │  │  (合约交互)      │ │
                    │  └────────┬─────────┘ │
                    └───────────┼───────────┘
                                │
                    ┌───────────▼───────────┐
                    │   Ethers.js Provider  │
                    │   (RPC: Sepolia)      │
                    └───────────┬───────────┘
                                │
                    ┌───────────▼───────────┐
                    │   智能合约 (Sepolia)   │
                    │   FGOGame.sol         │
                    │   0x...              │
                    └───────────────────────┘
```

#### 数据流程图

**1. 游戏初始化流程（以太坊模式）**

```
用户点击"以太坊游玩"
    ↓
前端生成 sessionId
    ↓
显示 WalletConnect 组件
    ↓
用户连接 MetaMask 钱包
    ↓
前端调用 payEntryFeeViaContract()
    ↓
MetaMask 弹出交易确认
    ↓
用户确认交易
    ↓
调用智能合约 startGame(sessionId)
    ↓
交易确认后，前端调用 POST /api/game/new
    ↓
后端创建游戏状态，返回 gameState
    ↓
前端进入 MainGame 界面
```

**2. 完成轮次流程**

```
玩家完成一轮游戏
    ↓
前端调用 POST /api/game/:sessionId/level/complete
    ↓
后端更新游戏状态（GameState.js）
    ↓
后端检查 gameMode === 'ethereum'
    ↓
后端调用 contract.completeLevel(sessionId, level, isPostLevel5)
    ↓
智能合约记录奖励，更新 totalReward
    ↓
后端返回更新后的游戏状态
    ↓
前端更新界面显示
```

**3. 完成游戏流程**

```
玩家主动完成游戏或达到胜利条件
    ↓
前端调用 POST /api/game/:sessionId/game/complete
    ↓
后端检查合约中已完成的轮数
    ↓
后端补全缺失的 completeLevel 调用
    ↓
后端调用 contract.completeGame(sessionId)
    ↓
智能合约自动支付奖励给玩家地址
    ↓
后端返回最终游戏状态
    ↓
前端跳转到 GameOverPage
    ↓
显示奖励信息和提取按钮
```

**4. 提取奖励流程**

```
玩家点击"提取奖励"按钮
    ↓
前端调用 wallet.claimReward()
    ↓
前端直接调用智能合约 claimReward()
    ↓
MetaMask 弹出交易确认
    ↓
用户确认交易
    ↓
智能合约转账奖励到玩家钱包
    ↓
前端显示提取成功
```

#### 关键技术点

**1. SessionId 一致性**
- 前端生成 `sessionId` 后，在支付入场费时传递给智能合约
- 后端使用相同的 `sessionId` 调用合约方法
- 使用 `ethers.id(sessionId)` 将字符串转换为 `bytes32` 类型

**2. 奖励同步机制**
- 后端在完成轮次时立即调用 `completeLevel` 记录奖励
- 完成游戏前检查并补全缺失的轮次记录
- 确保链上奖励与游戏进度一致

**3. 错误处理**
- 前端捕获 MetaMask 错误（用户拒绝、余额不足等）
- 后端捕获合约调用错误（交易失败、gas不足等）
- 实现重试机制和错误提示

**4. 状态同步**
- 前端通过轮询或 WebSocket 同步游戏状态
- 后端在关键操作后返回最新状态
- 合约事件可用于监听状态变化

---

### 4.4 试玩效果截图

#### 4.4.1 游戏开始界面

![ef3609b9895d48eadea20b403790d56b](D:\fgochaingame\fgoslotgame\md\ef3609b9895d48eadea20b403790d56b.png)

**说明：**
- 显示两种游戏模式选择：游客游玩和以太坊游玩
- 界面简洁，采用 FGO 主题配色
- 游客模式无需配置即可开始

#### 4.4.2 钱包连接界面

![779cfba4275d10ebc3ea0b10240eddf6](D:\fgochaingame\fgoslotgame\md\779cfba4275d10ebc3ea0b10240eddf6.png)

**说明：**
- 显示"连接钱包"按钮
- 连接后显示钱包地址和余额（SepETH）
- 显示"支付入场费"按钮（0.05 ETH）
- 支付成功后自动进入游戏

#### 4.4.3 主游戏界面

![23f036c3b2d63c739fa7a2f581d08847](D:\fgochaingame\fgoslotgame\md\23f036c3b2d63c739fa7a2f581d08847.png)

**说明：**
- 顶部显示游戏信息：轮数、回合数、量子、圣晶石
- 中央显示老虎机（3×5 网格）
- 右侧显示从者管理面板
- 底部显示操作按钮：旋转老虎机、完成游戏等
- 支持"完成游戏并提取奖励"功能

#### 4.4.4 从者商店界面

![da93f88e36bc935fc0f3d1b5f137c645](D:\fgochaingame\fgoslotgame\md\da93f88e36bc935fc0f3d1b5f137c645.png)

**说明：**
- 显示当前回合可购买的从者（3个）
- 显示从者价格（圣晶石）
- 显示从者效果描述
- 支持购买和激活从者
- 支持从者下场功能

#### 4.4.5 老虎机旋转效果

![08032febaa06db4e70cdb28bf9a8087a](D:\fgochaingame\fgoslotgame\md\08032febaa06db4e70cdb28bf9a8087a.png)

**说明：**
- 显示 3×5 网格的老虎机结果
- 高亮显示匹配的形状（横三、竖三、横五、V形、全满）
- 显示本轮获得的量子奖励
- 显示剩余旋转次数

#### 4.4.6 事件选择界面

![cb1382cd4241a0dd91e2e78eb815647c](D:\fgochaingame\fgoslotgame\md\cb1382cd4241a0dd91e2e78eb815647c.png)

**说明：**
- 每轮开始前弹出事件选择界面
- 显示三个可选事件
- 事件类型：增加概率权重、增加基础倍率、全满形状奖励
- 莉莉丝从者可额外选择一次事件

#### 4.4.7 游戏结束界面

![77aee7f99e7d8ba50ca11aedeabb75f4](D:\fgochaingame\fgoslotgame\md\77aee7f99e7d8ba50ca11aedeabb75f4.png)

**说明：**
- 显示游戏统计信息：总轮数、总回合数、总量子等
- 以太坊模式下显示：
  - 累计奖励（ETH）
  - 支付状态
  - "提取奖励"按钮
- 显示"重新开始"按钮，返回模式选择界面

#### 4.4.8 MetaMask 交易确认

![2eb1c27536c119b70267518f676ad550](D:\fgochaingame\fgoslotgame\md\2eb1c27536c119b70267518f676ad550.png)

**说明：**
- 支付入场费时的 MetaMask 弹窗
- 显示交易金额（0.05 ETH）
- 显示 Gas 费用估算
- 用户确认后交易提交到 Sepolia 网络

#### 4.4.9 奖励提取成功

![77aee7f99e7d8ba50ca11aedeabb75f4](D:\xwechat_files\wxid_nib015529jkt22_4047\temp\RWTemp\2026-01\9e20f478899dc29eb19741386f9343c8\77aee7f99e7d8ba50ca11aedeabb75f4.png)

**说明：**
- 显示奖励提取成功的提示
- 显示交易哈希（可点击查看 Etherscan）
- 显示提取的 ETH 金额
- 钱包余额更新

#### 4.4.10 Sepolia 区块浏览器

![e20d6a1b101a837a18559e86e1d4d81a](D:\xwechat_files\wxid_nib015529jkt22_4047\temp\RWTemp\2026-01\9e20f478899dc29eb19741386f9343c8\e20d6a1b101a837a18559e86e1d4d81a.png)

**说明：**
- 在 Sepolia Etherscan 上查看合约交易
- 显示 `startGame` 交易详情
- 显示 `completeLevel` 交易记录
- 显示 `completeGame` 和奖励支付交易
- 验证智能合约交互的透明性

---

## 五、总结

本项目成功实现了一个基于以太坊的 FGO 主题老虎机游戏，主要特点包括：

1. **完整的游戏机制**：实现了老虎机、从者系统、事件系统等核心玩法
2. **区块链集成**：使用智能合约管理入场费和奖励支付，确保透明和去中心化
3. **用户体验优化**：支持游客模式和以太坊模式，提供流畅的游戏体验
4. **安全性保障**：使用智能合约确保资金安全，防止作弊

项目展示了 Web3 游戏开发的核心技术栈，为后续开发更复杂的链游提供了基础框架。





项目链接：https://github.com/zsz523/fgoslotgame